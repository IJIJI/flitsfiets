
on:
  push:
    paths:
      - app/**
    branches:
      - main
  pull_request:
    branches-ignore: "**"
name: ðŸš€ðŸš€ (MAIN-Build-Push) Build and deploy

jobs:
  build:
    runs-on: ubuntu-24.04
    defaults:
      run:
        working-directory: ./app
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Print Tree
        run: tree

      - name: Make production envfile
        uses: SpicyPizza/create-envfile@v2.0
        with:
          envkey_SMTP_HOST: ${{ secrets.ENV_SMTP_HOST}}
          envkey_SMTP_USERNAME: ${{ secrets.ENV_SMTP_USERNAME}}
          envkey_SMTP_PASSWORD: ${{ secrets.ENV_SMTP_PASSWORD}}
          envkey_SMTP_PORT: 587
          envkey_JWT_SECRET: ${{ secrets.ENV_JWT_SECRET}}
          envkey_POSTGRES_PASSWORD: ${{ secrets.ENV_POSTGRES_PASSWORD}}
          directory: './app/'
          file_name: .env

      # - name: Set up JDK
      #   uses: actions/setup-java@v4
      #   with:
      #     java-version: '25'
      #     distribution: 'corretto'

      # - name: Cache Maven dependencies
      #   uses: actions/cache@v4
      #   with:
      #     path: ~/.m2/repository
      #     key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
      #     restore-keys: |
      #       ${{ runner.os }}-maven-

      # - name: Build with Maven
      #   run: mvn --batch-mode clean test

      # - name: Build Spring Boot Docker image
      #   run: .\mvnw package



      - name: Copying files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          # host: ${{ secrets.SSH_HOST }}:${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASS }}
          # key: ${{ secrets.SSH_PRIVATE }}
          # passphrase: ''
          rm: true
          source: "./app/."
          target: ~/flitsfiets/upload/
          strip_components: 2

      # Run commands on production
      - name: Executing remote ssh commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASS }}
          # key: ${{ secrets.SSH_PRIVATE }}
            
          script: |
            cd ~/flitsfiets/upload
            mvn install
            docker compose down
            docker compose up --wait
            
